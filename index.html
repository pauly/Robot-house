<!DOCTYPE html>
<html><head>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
  <script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
  <meta name="viewport" content="width=device-width,user-scalable=no" />
  <title>Robot Butler</title>
</head>
<body>
  <div data-role="page">
    <div data-role="header">
      <h1>Robot Butler</h1>
    </div>
    <div data-role="content">
      <p>This is my html5 based robot butler app, turn the lights on and off and so on.</p>
      <p><a href="#page2"><img src="res/drawable-xhdpi/ic_launcher.png" width="96" height="96" alt="robot butler" /></a></p>
      <p><a href="#page2">Let's go</a>...</p>
    </div>
    <div data-role="footer">
      <h4>By <a href="http://www.clarkeology.com/blog/">Paul Clarke</a>.</h4>
    </div>
  </div>
  <div data-role="page" id="page2">
    <div data-role="header">
      <h1>Robot Butler</h1>
    </div>
    <div data-role="content">
      <div data-role="collapsible">
        <h1>Activity</h1>
        <div class="activity">
          <p>Buttons will go here to turn devices on and off...</p>
        </div>
      </div>
      <div data-role="collapsible">
        <h1>Config</h1>
        <div class="config"></div>
        <!-- <p><a data-role="button" class="add_room">add a room</a></p>
        <p><a data-role="button" class="reset">reset</a></p> -->
      </div>
    </div>
    <div data-role="footer">
      <h4>By <a href="http://www.clarkeology.com/blog/">Paul Clarke</a>.</h4>
    </div>
  </div>
  <script>
    var defaultDevice = function ( i ) {
      return 'Device ' + i;
    };
    var defaultRoom = function ( i ) {
      return {
        name: 'Room ' + i,
        device: [
          defaultDevice( 1 )
        ]
      };
    };
    var defaultConfig = {
      url: 'http://ourduino.no-ip.org/config',
      version: 0.1,
      date: new Date( ),
      room: [
        defaultRoom( 1 )
      ]
    };
    var config = defaultConfig;
    var debug = function ( msg, c ) {
      window.console && console.log( msg );
      output( '<pre>' + ( typeof( msg ) === 'string' ? msg : JSON.stringify( msg )) + '</pre>', c );
    };
    var error = function ( msg ) {
      debug( 'ERROR: ' + msg );
    };
    var output = function ( msg, c ) {
      $( c || '.config' ).append( msg );
    };
    var getConfig = function ( callback ) {
      var c;
      try {
        c = JSON.parse( localStorage.getItem( 'config' ));
}
catch ( e ) {
}
      if ( c && c.config ) debug( 'stored config is', c.config );
      if ( config && config.url ) {
	alert( 'getting ' + config.url );
        $.get( config.url, function ( data ) {
	  alert( 'got ' + config.url );
          debug( 'config from ' + config.url + ' was ' + JSON.stringify( data ));
          callback( data || config );
        } );
	alert( 'called get' );
      }
      else {
        callback( c.config || config );
      }
    };
    var setConfig = function ( config ) {
      try {
        config.date = new Date( );
        localStorage.setItem( 'config', JSON.stringify( config ));
      }
      catch ( e ) {
        error( e );
      }
    };
    $('#page2').bind( 'pageinit', function ( ) {
      try {
        /* var size = function( obj ) {
          if ( obj.length ) return obj.length;
	  var len = 0, key;
	  for ( key in obj ) {
	    if ( obj.hasOwnProperty( key )) len ++;
	  }
	  return len;
	};
	var formToObj = function ( ) {
	  var obj = { };
	  function add( obj, name, value ) {
	    var key = name.shift( );
	    // if ( key && key.match( /^\d+$/ )) {
	    //  key = parseInt( key );
	    // }
	    if ( name.length ) {
	      if ( obj[key] == null ) {
		obj[key] = { };
	      }
	      add( obj[key], name, value );
	    }
	    else {
	      obj[key] = value;
	    }
	  }; 
	  $('.config').find('input, textarea, select').each( function( ) {
	    add( obj, $(this).attr('name').split('.'), $(this).val( ));
	  } );
	  return obj;
	};
	var makeInputName = function ( name, prefix ) {
	  var c = prefix.slice( 0 ); // take a copy
	  c.push( name );
	  return c.join('.').replace( /^\.+/, '' ).replace( /\.{2,}/g, '.' );
	};
	var input = function ( name, val, prefix ) {
	  var inputName = makeInputName( name, prefix );
	  switch ( name ) {
	    case 'date':
	    case 'version':
	      return '<input type="hidden" name="' + inputName + '" value="' + val + '" />';
	    case 'type':
	      return '<div><label for="' + inputName + '">' + name + '</label><select id="' + inputName + '" name="' + inputName + '"><option value="button">button<option><option value="switch"' + ( val === 'switch' ? 'selected="selected"' : '' ) + '>switch</option></select></div>';
	    default:
	      return '<div><label for="' + inputName + '">' + name + '</label><input id="' + inputName + '" name="' + inputName + '" value="' + val + '" /></div>';
	  }
	};
	var fieldset = function ( name, obj, prefix ) {
	  var r = '';
	  if ( typeof obj === 'object' ) {
	    var parts = '';
	    prefix.push( name );
	    for ( var i in obj ) {
	      parts += fieldset( i, obj[i], prefix );
	    }
	    if ( parts ) {
	      if ( name ) {
		parts = '<fieldset><legend>' + name + '</legend>' + parts + '</fieldset>';
	      }
	      r += parts;
	    }
	  }
	  else {
	    r += input( name, obj, prefix );
	  }
	  return r; 
	};
	var objToForm = function ( name, obj, prefix ) {
	  output( '<form>' + fieldset( name, obj, [ prefix ] ) + '</form>' );
	};
	*/
	var activityForm = function ( config ) {
	  $('.activity').html('');
	  config.room && $.each( config.room, function ( ) {
	    var room = this.name;
	    this.device && $.each( this.device, function ( ) {
	      var $form = $('<form />')
		.append('<legend>' + room + ' ' + this + '</legend>')
		// .attr( 'action', ( this.protocol || 'http' ) + '://' + this.ip + '/' + this.pin );
		.attr( 'action', config.url + '/room/' + room + '/' + this );
	      var $input;
	      switch ( this.type ) {
		case 'button':
		  $input = $('<button>' + this + '</button>');
		  $form.append( $input );
		  $input.button( );
		  break;
		default:
		  $input = $('<select><option value="off">off</option><option value="on"' + ( this.value ? ' selected' : '' ) + '>on</option></select>');
		  $form.append( $input );
		  $input.slider( ); // covered below?
	      }
	      $input.change( function ( ) {
		$.ajax( {
		  url: $input.parents('form').attr('action') + '?status=' + $input.val( ) + '&_=' + new Date( ),
		  type: 'PUT',
		  success: function ( js ) {
		    debug( 'receieved: ' + JSON.stringify( js ), '.activity' );
		  },
		  error: function ( xhr, status, error ) {
		    debug( status + ' ' + error, '.activity' );
		  }
		} );
	      } );
	      $form.find('select').slider( );
	      $('.activity').append( $form );
	    } );
	  } );
	};
	alert( 'starting' );
	if ( typeof localStorage === 'undefined' ) {
	  alert( 'Doh, no html local storage!' );
	}
	else {
	  alert( 'getting config' );
	  getConfig( function ( config ) {
	    setConfig( config );
	    activityForm( config );
	  } );
	}
      }
      catch ( e ) {
        alert( 'caught error; ' + e );
      }
    } );
  </script>
</body></html>
