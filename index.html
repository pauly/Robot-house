<!DOCTYPE html>
<html><head>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
  <script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
  <meta name="viewport" content="width=device-width,user-scalable=no" />
  <title>Robot Butler</title>
</head>
<body>
  <div data-role="page">
    <div data-role="header">
      <h1>Robot Butler</h1>
    </div>
    <div data-role="content">
      <p>This is my html5 based robot butler app, turn the lights on and off and so on.</p>
      <p><a href="#page2"><img src="res/drawable-xhdpi/ic_launcher.png" width="96" height="96" alt="robot butler" /></a></p>
      <p><a href="#page2">Let's go</a>...</p>
    </div>
    <div data-role="footer">
      <h4>By <a href="http://www.clarkeology.com/blog/">Paul Clarke</a>.</h4>
    </div>
  </div>
  <div data-role="page" id="page2">
    <div data-role="header">
      <h1>Robot Butler</h1>
    </div>
    <div data-role="content">
      <div data-role="collapsible-set">
        <div data-role="collapsible">
          <h1>Sequences / shortcuts</h1>
          <div class="sequences" data-role="collapsible-set">
            <p>Buttons will go here to execute sequences...</p>
          </div>
        </div>
        <div data-role="collapsible">
          <h1>Rooms</h1>
          <div class="rooms" data-role="collapsible-set">
            <p>Buttons will go here to turn individual devices on and off...</p>
          </div>
        </div>
        <div data-role="collapsible">
          <h1>Config / registration</h1>
          <div class="config"></div>
          <!-- <p><a data-role="button" class="add_room">add a room</a></p>
          <p><a data-role="button" class="reset">reset</a></p> -->
        </div>
      </div>
    </div>
    <div data-role="footer">
      <h4>By <a href="http://www.clarkeology.com/blog/">Paul Clarke</a>.</h4>
    </div>
  </div>
  <script>
    var defaultDevice = function ( i ) {
      return 'Device ' + i;
    };
    var defaultRoom = function ( i ) {
      return {
        name: 'Room ' + i,
        device: [
          defaultDevice( 1 )
        ]
      };
    };
    var defaultConfig = {
      url: 'http://192.168.1.73',
      version: 0.1,
      date: new Date( ),
      room: [
        defaultRoom( 1 )
      ]
    };
    var defaultAppConfig = {
      url: defaultConfig.url,
      version: defaultConfig.version,
      date: defaultConfig.date
    };
    var config = defaultConfig;
    var appConfig = defaultAppConfig;
    var debug = function ( msg, c ) {
      window.console && console.log( msg );
      output( '<p>' + ( typeof( msg ) === 'string' ? msg : JSON.stringify( msg )) + '</p>', c );
    };
    var error = function ( msg ) {
      debug( 'ERROR: ' + msg );
    };
    var output = function ( msg, c ) {
      $( c || '.config' ).append( msg );
    };
    var url = function ( path, params ) {
      path = appConfig.url + path;
      path += '?key=' + appConfig.key;
      path += '&_=' + new Date( );
      for ( var key in params ) {
        if ( params.hasOwnProperty( key )) {
          path += '&' + key + '=' + params[ key ];
        }
      }
      return path;
    };
    var getConfig = function ( callback ) {
      var c;
      try {
        c = localStorage.getItem( 'config' );
        if ( c ) {
          c = JSON.parse( c );
          debug( 'stored config is ' + JSON.stringify( c ));
          config = c;
        }
        c = localStorage.getItem( 'app-config' );
        if ( c ) {
          c = JSON.parse( c );
          debug( 'stored app config is ' + JSON.stringify( c ));
          appConfig = c;
        }
        appConfig.url = appConfig.url || config.url;
        appConfig.key = appConfig.key || 'foo';
      }
      catch ( e ) {
        debug( 'error getting config from local storage; ' + e );
      }
      if ( appConfig && appConfig.url ) {
        $.ajax( {
          url: url( '/config' ),
          type: 'GET',
          success: function ( data ) {
            callback( data || config, appConfig );
          },
          error: function ( xhr, status, error ) {
            debug( status + ' ' + error + ' at least we have the stored config...', '.rooms' );
          }
        } );
      }
      else {
        callback( c.config || config, appConfig );
      }
    };
    var setConfig = function ( name, config ) {
      try {
        config.date = new Date( );
        localStorage.setItem( name, JSON.stringify( config ));
        debug( name + ' is now ' + localStorage.getItem( name ));
      }
      catch ( e ) {
        error( 'error setting ' + name + '; ' + e );
      }
    };
    $('#page2').bind( 'pageinit', function ( ) {
      try {
        var input = function ( name, val, prefix ) {
          var inputName = makeInputName( name, prefix );
          switch ( name ) {
            case 'date':
            case 'version':
              return '<input type="hidden" name="' + inputName + '" value="' + val + '" />';
            case 'type':
              return '<div><label for="' + inputName + '">' + name + '</label><select id="' + inputName + '" name="' + inputName + '"><option value="button">button<option><option value="switch"' + ( val === 'switch' ? 'selected="selected"' : '' ) + '>switch</option></select></div>';
            default:
              return '<div><label for="' + inputName + '">' + name + '</label><input id="' + inputName + '" name="' + inputName + '" value="' + val + '" /></div>';
          }
        };
        var activityForm = function ( config ) {
          $('.sequences').html('');
          config.sequence && $.each( config.sequence, function ( name, sequence ) {
            var $input = $('<a>' + name + '</a>')
              .button( )
              .click( function ( ) {
                $.ajax( {
                  url: url( '/sequence/' + name, { status: $input.val( ) } ),
                  type: 'PUT',
                  error: function ( xhr, status, error ) {
                    debug( status + ' ' + error, '.rooms' );
                  }
                } );
                return false;
              } );
            $form = $( '<form />' )
              .append( $input );
            $('.sequences')
              .append( $form )
              .append( '<p>' + sequence + '</p>' );
          } );
          $('.rooms').html('');
          config.room && $.each( config.room, function ( ) {
            var room = this.name;
            var $div = $( '<div><h1>' + room + '</h1></div>' );
            this.device && $.each( this.device, function ( ) {
              var $form = $( '<form />' )
                .append('<legend><h2>' + this + '</h2></legend>')
                .attr( 'action', room + '/' + this );
              var $input;
              switch ( this.type ) {
                case 'button':
                  $input = $('<button>' + this + '</button>');
                  $input.button( );
                  break;
                default:
                  // if ( this.substr( 0, 5 ) === 'light' ) { // hmm
                  //   $input = $( '<input type="range" value="50" min="0" max="100" />' );
                  // }
                  $input = $('<select><option value="off">off</option><option value="on"' + ( this.value ? ' selected' : '' ) + '>on</option></select>');
              }
              $form.append( $input );
              $input.change( function ( ) {
                $.ajax( {
                  url: url( '/room/' + $input.parents('form').attr('action'), { status: $input.val( ) } ),
                  type: 'PUT',
                  // success: function ( data ) {
                  //   debug( 'receieved: ' + JSON.stringify( data ), '.rooms' );
                  // },
                  error: function ( xhr, status, error ) {
                    debug( status + ' ' + error, '.rooms' );
                  }
                } );
              } );
              $div.append( $form );
            } );
            $div.find('select,input[type="range"]').slider( );
            $div.collapsible( );
            $('.rooms').append( $div );
          } );
        };
        var configForm = function ( config ) {
          $('.config').html('');
          $form = $( '<form />' );
          $.each( config, function ( key, value ) {
            var $input = $('<input />')
              .textinput( )
              .attr( 'name', key )
              .val( value )
              .change( function ( ) {
                config[ key ] = this.value;
                setConfig( 'app-config', config );
              } )
            $form.append( $input );
          } );
          $('.config').append( $form );
        };
        if ( typeof localStorage === 'undefined' ) {
          alert( 'Doh, no html local storage!' );
        }
        else {
          getConfig( function ( config, appConfig ) {
            setConfig( 'config', config );
            setConfig( 'app-config', appConfig );
            activityForm( config );
            configForm( appConfig );
          } );
        }
      }
      catch ( e ) {
        alert( 'caught error; ' + e );
      }
    } );
  </script>
</body></html>
