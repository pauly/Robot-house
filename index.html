<!DOCTYPE html>
<html><head>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
  <script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
  <meta name="viewport" content="width=device-width,user-scalable=no" />
  <title>Robot House</title>
</head>
<body>
  <div data-role="page">
    <div data-role="header">
      <h1>Robot House</h1>
    </div>
    <div data-role="content">
      <p>This is my html5 based robot butler app.</p>
      <p><a href="#page2"><img src="res/drawable-xhdpi/ic_launcher.png" width="96" height="96" alt="robot butler" /></a></p>
      <p><a href="#page2">Let's go</a>...</p>
    </div>
    <div data-role="footer">
      <h4>By <a href="http://www.clarkeology.com/blog/">Paul Clarke</a>.</h4>
    </div>
  </div>
  <div data-role="page" id="page2">
    <div data-role="header">
      <h1>Robot House</h1>
    </div>
    <div data-role="content">
      <div data-role="collapsible">
        <h1>Activity</h1>
        <div class="activity">
          <p>Still to be completed, buttons will go here to turn stuff on and off...</p>
        </div>
      </div>
      <div data-role="collapsible">
        <h1>Config</h1>
        <div class="config">
        </div>
        <p><a data-role="button" class="add_room">add a room</a></p>
        <p><a data-role="button" class="reset">reset</a></p>
      </div>
    </div>
    <div data-role="footer">
      <h4>By <a href="http://www.clarkeology.com/blog/">Paul Clarke</a>.</h4>
    </div>
  </div>
  <script>
    var default_device = function ( i ) {
      return {
        name: 'Device ' + i,
        type: 'button',
        // protocol: 'http',
        ip: '192.168.0.' + ( 100 + i ),
        pin: 13,
        value: null 
      };
    };
    var default_room = function ( i ) {
      return {
        name: 'Room ' + i,
        device: [
          default_device( i )
        ]
      };
    };
    var default_config = {
      version: 0.1,
      date: new Date( ),
      room: [
        default_room( 1 )
      ]
    };
    $('#page2').bind( 'pageinit', function ( ) {
      var size = function( obj ) {
        // if ( obj.length ) return obj.length;
        var len = 0, key;
        for ( key in obj ) {
          if ( obj.hasOwnProperty( key )) len ++;
        }
        return len;
      };
      var output = function ( msg ) {
        $('.config').append( msg );
      };
      var debug = function ( msg ) {
        window.console && console.log( msg );
        output( '<pre>' + ( typeof( msg ) === 'string' ? msg : JSON.stringify( msg )) + '</pre>' );
      };
      var form_to_obj = function ( ) {
        var obj = { };
        function add( obj, name, value ) {
          var key = name.shift( );
          // if ( key && key.match( /^\d+$/ )) {
          //  key = parseInt( key );
          // }
          if ( name.length ) {
            if ( obj[key] == null ) {
              obj[key] = { };
            }
            add( obj[key], name, value );
          }
          else {
            obj[key] = value;
          }
        }; 
        $('.config').find('input, textarea, select').each( function( ) {
          add( obj, $(this).attr('name').split('.'), $(this).val( ));
        } );
        return obj;
      };
      var error = function ( msg ) {
        debug( 'ERROR: ' + msg );
      };
      var make_input_name = function ( name, prefix ) {
        var c = prefix.slice( 0 ); // take a copy
        c.push( name );
        return c.join('.').replace( /^\.+/, '' ).replace( /\.{2,}/g, '.' );
      };
      var input = function ( name, val, prefix ) {
        var input_name = make_input_name( name, prefix );
        switch ( name ) {
          case 'date':
          case 'version':
            return '<input type="hidden" name="' + input_name + '" value="' + val + '" />';
          case 'type':
            return '<div><label for="' + input_name + '">' + name + '</label><select id="' + input_name + '" name="' + input_name + '"><option value="button">button<option><option value="switch"' + ( val === 'switch' ? 'selected="selected"' : '' ) + '>switch</option></select></div>';
          default:
            return '<div><label for="' + input_name + '">' + name + '</label><input id="' + input_name + '" name="' + input_name + '" value="' + val + '" /></div>';
        }
      };
      var fieldset = function ( name, obj, prefix ) {
        var r = '';
        if ( typeof( obj ) === 'object' ) {
          var parts = '';
          prefix.push( name );
          for ( var i in obj ) {
            parts += fieldset( i, obj[i], prefix );
          }
          if ( parts ) {
            if ( name ) {
              parts = '<fieldset><legend>' + name + '</legend>' + parts + '</fieldset>';
            }
            r += parts;
          }
        }
        else {
          r += input( name, obj, prefix );
        }
        return r; 
      };
      var obj_to_form = function ( name, obj, prefix ) {
        output( '<form>' + fieldset( name, obj, [ prefix ] ) + '</form>' );
      };
      var get_config = function ( ) {
        var c = JSON.parse( localStorage.getItem( 'config' ));
        if ( c && c.config ) return c.config;
        return c || default_config;
      };
      var set_config = function ( config ) {
        try {
          config.date = new Date( );
          localStorage.setItem( 'config', JSON.stringify( config ));
          // debug( 'saved config' );
          // debug( config );
        }
        catch ( e ) {
          error( e );
        }
      };
      var activity_form = function ( config ) {
        $('.activity').html('');
        config.room && $.each( config.room, function ( ) {
          var room = this.name;
          this.device && $.each( this.device, function ( ) {
            var $form = $('<form />')
              .append('<legend>' + room + ' ' + this.name + '</legend>')
              .attr( 'action', ( this.protocol || 'http' ) + '://' + this.ip + '/' + this.pin );
            switch ( this.type ) {
              case 'button':
                var $button = $('<button>' + this.name + '</button>');
                $form.append( $button );
                $button.button( );
                $button.click( function ( ) {
                  debug( 'POST ' + $button.parents('form').attr('action'));
                  $.post( $button.parents('form').attr('action'), function ( js ) {
                    debug( js );
                  } );
                } );
                break;
              default:
                var $select = $('<select><option value="0">off</option><option value="1"' + ( this.value ? ' selected' : '' ) + '>on</option></select>');
                $form.append( $select );
                $select.slider( );
                $select.change( function ( ) {
                  debug( 'POST ' + $select.parents('form').attr('action') + '/' + $select.val( ));
                  $.post( $select.parents('form').attr('action') + '/' + $select.val( ), function ( js ) {
                    debug( js );
                  } );
                } );
            }
            $form.find('select').slider( );
            $('.activity').append( $form );
          } );
        } );
      };
      var config;
      if ( typeof( localStorage ) == 'undefined' ) {
        error( 'Doh, no html local storage!' );
      }
      else {
        config = get_config( );
        // make config form
        output( obj_to_form( '', config, 'config' ));
        // make activity forms
        activity_form( config );
      }
      $('input').change( function ( ) {
        config = form_to_obj( );
        set_config( config );
      } );
      $('.add_room').click( function ( ) {
        var r = size( config.room );
        config.room[ r ] = default_room( 1 + r );
        set_config( config );
        $('.content').html( '' );
        output( obj_to_form( '', config, 'config' ));
        activity_form( config );
      } );
      $('.reset').click( function ( ) {
        set_config( default_config );
        $('.content').html( '' );
        config = get_config( );
        output( obj_to_form( '', config, 'config' ));
        activity_form( config );
      } );
    } );
  </script>
</body></html>
